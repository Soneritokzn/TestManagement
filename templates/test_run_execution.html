<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Run Execution</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 max-w-7xl">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-4xl font-bold text-gray-800" id="run-name">Test Run Execution</h1>
                <p class="text-gray-600 mt-2" id="run-description"></p>
            </div>
            <div class="flex gap-2">
                <a href="/" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Back to Dashboard</a>
                <button onclick="saveAllResults()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Save All</button>
                <button onclick="deleteTestRun()" class="bg-red-500 text-white px-4 py-2 rounded-lg">Delete Test Run</button>
            </div>
        </div>

        <div id="executions-container" class="space-y-6">
            <!-- Test case executions will be loaded here -->
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const TEST_RUN_ID = {{ test_run_id }};
        let testRunData = null;
        let executionData = {};

        // Load test run on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTestRun();
        });

        async function loadTestRun() {
            try {
                const res = await fetch(`${API_BASE}/testruns/${TEST_RUN_ID}`);
                testRunData = await res.json();
                
                document.getElementById('run-name').textContent = testRunData.name;
                document.getElementById('run-description').textContent = testRunData.description || '';
                
                renderExecutions();
            } catch (err) {
                console.error('Error loading test run:', err);
                alert('Error loading test run');
            }
        }

        function renderExecutions() {
            const container = document.getElementById('executions-container');
            
            container.innerHTML = testRunData.executions.map(execution => {
                const tc = execution.test_case;
                const executionId = execution.id;
                
                // Initialize execution data if not exists
                if (!executionData[executionId]) {
                    executionData[executionId] = {
                        status: execution.status,
                        steps: tc.steps.map(step => ({
                            id: step.id,
                            actual_result: step.actual_result || ''
                        }))
                    };
                }
                
                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg" data-execution-id="${executionId}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h2 class="text-2xl font-semibold mb-2">${tc.name}</h2>
                                <p class="text-gray-600 mb-2">${tc.description}</p>
                                <div class="flex gap-4 text-sm text-gray-500">
                                    <span>Category: ${tc.category || 'N/A'}</span>
                                    <span>Priority: <span class="font-semibold ${getPriorityColorClass(tc.priority)}">${tc.priority}</span></span>
                                </div>
                                ${tc.precondition ? `<div class="mt-2"><strong>Precondition:</strong> ${tc.precondition}</div>` : ''}
                                ${tc.postcondition ? `<div class="mt-2"><strong>Postcondition:</strong> ${tc.postcondition}</div>` : ''}
                            </div>
                            <div class="flex flex-col gap-2 ml-4">
                                <span class="px-3 py-1 rounded text-sm font-semibold ${getStatusColorClass(execution.status)}">${execution.status}</span>
                                <div class="flex gap-2">
                                    <button onclick="setStatus(${executionId}, 'Passed')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Passed</button>
                                    <button onclick="setStatus(${executionId}, 'Failed')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">Failed</button>
                                    <button onclick="setStatus(${executionId}, 'Blocked')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">Blocked</button>
                                    <button onclick="setStatus(${executionId}, 'Skipped')" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm">Skipped</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4 mt-4">
                            <h3 class="text-lg font-semibold mb-4">Test Steps</h3>
                            <div class="space-y-4">
                                ${tc.steps.map((step, idx) => `
                                    <div class="border p-4 rounded-lg bg-gray-50">
                                        <div class="font-semibold mb-2">Step ${idx + 1}</div>
                                        <div class="mb-2"><strong>Description:</strong> ${step.description}</div>
                                        <div class="mb-2"><strong>Expected Result:</strong> ${step.expected_result}</div>
                                        <div class="mb-2">
                                            <label class="block text-gray-700 font-medium mb-1">Actual Result:</label>
                                            <textarea 
                                                id="step-${executionId}-${step.id}" 
                                                class="w-full p-2 border border-gray-300 rounded-lg" 
                                                rows="2"
                                                onchange="updateStepResult(${executionId}, ${step.id}, this.value)"
                                                placeholder="Enter actual result here...">${step.actual_result || ''}</textarea>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="mt-4 flex justify-end gap-2">
                            <button onclick="saveExecution(${executionId})" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Save Execution</button>
                            <button onclick="deleteExecution(${executionId})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusColorClass(status) {
            const colors = {
                'Not Run': 'bg-gray-200 text-gray-800',
                'Passed': 'bg-green-200 text-green-800',
                'Failed': 'bg-red-200 text-red-800',
                'Blocked': 'bg-yellow-200 text-yellow-800',
                'Skipped': 'bg-blue-200 text-blue-800'
            };
            return colors[status] || 'bg-gray-200 text-gray-800';
        }

        function getPriorityColorClass(priority) {
            const colors = {
                'Critical': 'text-red-600',
                'High': 'text-orange-600',
                'Medium': 'text-blue-600',
                'Low': 'text-green-600'
            };
            return colors[priority] || 'text-gray-600';
        }

        function setStatus(executionId, status) {
            if (!executionData[executionId]) {
                executionData[executionId] = { status: status, steps: [] };
            }
            executionData[executionId].status = status;
            
            // Update UI
            const executionCard = document.querySelector(`[data-execution-id="${executionId}"]`);
            const statusBadge = executionCard.querySelector('span');
            statusBadge.textContent = status;
            statusBadge.className = `px-3 py-1 rounded text-sm font-semibold ${getStatusColorClass(status)}`;
        }

        function updateStepResult(executionId, stepId, actualResult) {
            if (!executionData[executionId]) {
                executionData[executionId] = { status: 'Not Run', steps: [] };
            }
            
            let stepData = executionData[executionId].steps.find(s => s.id === stepId);
            if (!stepData) {
                stepData = { id: stepId, actual_result: '' };
                executionData[executionId].steps.push(stepData);
            }
            stepData.actual_result = actualResult;
        }

        async function saveExecution(executionId) {
            const data = executionData[executionId];
            if (!data) {
                alert('No changes to save');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/testruns/${TEST_RUN_ID}/executions/${executionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: data.status,
                        steps: data.steps,
                        notes: ''
                    })
                });
                
                if (res.ok) {
                    alert('Execution saved successfully!');
                    await loadTestRun(); // Reload to get updated data
                } else {
                    alert('Error saving execution');
                }
            } catch (err) {
                console.error('Error saving execution:', err);
                alert('Error saving execution');
            }
        }

        async function saveAllResults() {
            const executions = Object.keys(executionData);
            if (executions.length === 0) {
                alert('No changes to save');
                return;
            }
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const executionId of executions) {
                try {
                    const data = executionData[executionId];
                    const res = await fetch(`${API_BASE}/testruns/${TEST_RUN_ID}/executions/${executionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            status: data.status,
                            steps: data.steps,
                            notes: ''
                        })
                    });
                    
                    if (res.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (err) {
                    console.error(`Error saving execution ${executionId}:`, err);
                    errorCount++;
                }
            }
            
            if (errorCount === 0) {
                alert(`All ${successCount} executions saved successfully!`);
                await loadTestRun(); // Reload to get updated data
            } else {
                alert(`Saved ${successCount} executions. ${errorCount} errors occurred.`);
            }
        }

        async function deleteExecution(executionId) {
            if (!confirm('Are you sure you want to delete this execution?')) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/testruns/${TEST_RUN_ID}/executions/${executionId}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    // Remove from local data
                    delete executionData[executionId];
                    // Reload the page
                    await loadTestRun();
                    alert('Execution deleted successfully');
                } else {
                    alert('Error deleting execution');
                }
            } catch (err) {
                console.error('Error deleting execution:', err);
                alert('Error deleting execution');
            }
        }

        async function deleteTestRun() {
            if (!confirm('Are you sure you want to delete this entire test run? All executions will be deleted. This action cannot be undone.')) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/testruns/${TEST_RUN_ID}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    alert('Test run deleted successfully. Redirecting to dashboard...');
                    window.location.href = '/';
                } else {
                    alert('Error deleting test run');
                }
            } catch (err) {
                console.error('Error deleting test run:', err);
                alert('Error deleting test run');
            }
        }
    </script>
</body>
</html>

